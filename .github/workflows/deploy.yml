name: Deploy to Hostinger

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer Dependencies
      run: composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install NPM Dependencies and Build
      run: |
        npm ci
        npm run build

    - name: Prepare .env file
      run: |
        echo "${{ secrets.LARAVEL_ENV }}" > .env

    - name: Sync files to Hostinger
      uses: easingthemes/ssh-deploy@v5.0.0
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        ARGS: "-rlgoDzvc -i --delete"
        SSH_CMD_ARGS: "-o ConnectTimeout=60 -o ServerAliveInterval=60 -o StrictHostKeyChecking=no"
        SOURCE: "src/"
        TARGET: "/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/laravel_core" 
        REMOTE_HOST: ${{ secrets.HOSTINGER_IP }}
        REMOTE_PORT: ${{ secrets.HOSTINGER_PORT }}
        REMOTE_USER: ${{ secrets.HOSTINGER_USER }}
        EXCLUDE: "/node_modules/, /.git/, /.github/, /tests/, /storage/logs/*"

    - name: Execute Remote Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOSTINGER_IP }}
        username: ${{ secrets.HOSTINGER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.HOSTINGER_PORT }}
        command_timeout: 30m
        script: |
          PROJECT_ROOT="/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/laravel_core"
          PUBLIC_HTML="/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/public_html"
          PHP_BIN="/opt/alt/php82/usr/bin/php"
          
          cd $PROJECT_ROOT
          
          $PHP_BIN artisan migrate --force
          $PHP_BIN artisan config:cache
          $PHP_BIN artisan route:cache
          $PHP_BIN artisan view:cache
          $PHP_BIN artisan storage:link
          
          rsync -av $PROJECT_ROOT/public/ $PUBLIC_HTML/
          
          # Correção do sed para usar caminhos relativos seguros e evitar erro de sintaxe
          # Substitui __DIR__.'/../ por __DIR__.'/../laravel_core/
          sed -i "s|__DIR__.'/../|__DIR__.'/../laravel_core/|g" $PUBLIC_HTML/index.php
