name: Deploy to Hostinger

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer Dependencies
      run: composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Prepare .env file
      run: |
        echo "${{ secrets.LARAVEL_ENV }}" > .env

    # Usando FTP para transferir arquivos (Mais estável na Hostinger que Rsync/SSH repetido)
    - name: Upload files via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.HOSTINGER_IP }}
        username: ${{ secrets.HOSTINGER_USER }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./src/
        # Caminho remoto para a pasta laravel_core
        server-dir: /domains/academy2u.com/laravel_core/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/tests/**
          **/storage/logs/**

    # SSH apenas para rodar comandos finais (Rápido, menor chance de timeout)
    - name: Execute Remote Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOSTINGER_IP }}
        username: ${{ secrets.HOSTINGER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.HOSTINGER_PORT }}
        command_timeout: 30m
        script: |
          PROJECT_ROOT="/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/laravel_core"
          PUBLIC_HTML="/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/public_html"
          PHP_BIN="/opt/alt/php82/usr/bin/php"
          
          cd $PROJECT_ROOT
          
          $PHP_BIN artisan migrate --force
          $PHP_BIN artisan config:clear
          $PHP_BIN artisan route:clear
          $PHP_BIN artisan view:clear
          
          # Sincroniza a pasta public com a public_html
          rsync -av $PROJECT_ROOT/public/ $PUBLIC_HTML/
          
          # Ajusta o index.php
          sed -i "s|__DIR__.'/../|__DIR__.'/../laravel_core/|g" $PUBLIC_HTML/index.php
