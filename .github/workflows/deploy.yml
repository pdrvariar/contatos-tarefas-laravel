name: Deploy to Hostinger

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Define que todos os comandos 'run' devem ser executados dentro da pasta 'src'
    defaults:
      run:
        working-directory: ./src

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer Dependencies
      run: composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install NPM Dependencies and Build
      run: |
        npm ci
        npm run build

    - name: Prepare .env file
      run: |
        echo "${{ secrets.LARAVEL_ENV }}" > .env

    - name: Sync files to Hostinger
      uses: easingthemes/ssh-deploy@v5.0.0
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        ARGS: "-rlgoDzvc -i --delete"
        SOURCE: "src/"  # Envia o conteúdo da pasta src
        # Caminho ajustado para o seu domínio academy2u.com
        TARGET: "/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/laravel_core" 
        REMOTE_HOST: ${{ secrets.HOSTINGER_IP }}
        REMOTE_PORT: ${{ secrets.HOSTINGER_PORT }}
        REMOTE_USER: ${{ secrets.HOSTINGER_USER }}
        EXCLUDE: "/node_modules/, /.git/, /.github/, /tests/, /storage/logs/*"

    - name: Execute Remote Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOSTINGER_IP }}
        username: ${{ secrets.HOSTINGER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.HOSTINGER_PORT }}
        script: |
          # Variáveis ajustadas para academy2u.com
          PROJECT_ROOT="/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/laravel_core"
          PUBLIC_HTML="/home/${{ secrets.HOSTINGER_USER }}/domains/academy2u.com/public_html"
          
          cd $PROJECT_ROOT
          
          # Comandos Laravel
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan storage:link
          
          # Mover conteúdo da pasta public para public_html
          rsync -av $PROJECT_ROOT/public/ $PUBLIC_HTML/
          
          # Ajustar o index.php na public_html
          sed -i "s|__DIR__.'/../storage|'$PROJECT_ROOT'/storage|g" $PUBLIC_HTML/index.php
          sed -i "s|__DIR__.'/../vendor|'$PROJECT_ROOT'/vendor|g" $PUBLIC_HTML/index.php
          sed -i "s|__DIR__.'/../bootstrap|'$PROJECT_ROOT'/bootstrap|g" $PUBLIC_HTML/index.php
